// ============================================================
// SLiM 3 script: WF model with standing-variation sweep
// - Ne = 25,000 diploids
// - 1 chromosome, 1,000,000 bp
// - Neutral burn-in (250,000 generations)
// - One focal site at position 742,619 starts neutral, then becomes beneficial
// - Condition on focal allele being present at end of burn-in (restart until present)
// - Sample 8 diploids at t1 (end of burn-in) and 8 diploids at t2 = t1 + 5 gens
// - Output VCFs for both samples + tree sequence
// ============================================================


// ------------------------------
// Parameters (edit as needed)
// ------------------------------
defineConstant("Ne",         25000);
defineConstant("L",          1000000);
defineConstant("MU",         2.04e-9);   // per-base per-generation mutation rate
defineConstant("R",          1.0e-8);    // per-base per-generation recombination rate (reasonable default)
defineConstant("BURNIN",     250000);

defineConstant("FOCAL_POS",  742619);   // 0-based coordinates in SLiM
defineConstant("SEL_S",      0.05);     // selection coefficient after t1 (EDIT ME)
defineConstant("DOM_H",      0.5);      // additive dominance
defineConstant("SAMPLE_N",   8);
defineConstant("T2_OFFSET",  5);

// Filenames / prefixes
defineConstant("RESTART_FILE", "restart_state.slimbin");
defineConstant("VCF_T1",       "sample_t1_genotypes.vcf");
defineConstant("VCF_T2",       "sample_t2_genotypes.vcf");
defineConstant("TREES_OUT",    "simulation.trees");


// ============================================================
// initialize(): model setup
// ============================================================
initialize() {
    // Wright–Fisher, diploid
    initializeSLiMModelType("WF");

    // Tree-sequence recording ON
    initializeTreeSeq();

    // Genome basics
    initializeMutationRate(MU);
    initializeRecombinationRate(R);

    // Mutation types:
    // m1: neutral background
    // m2: focal-site mutation type (neutral during burn-in; becomes beneficial at t1)
    initializeMutationType("m1", 0.5, "f", 0.0);
    initializeMutationType("m2", DOM_H, "f", 0.0);  // starts neutral; we'll switch to +SEL_S later

    // Genomic element types:
    // g1: whole chromosome uses m1 (neutral)
    // g2: single-base element at focal position uses m2
    initializeGenomicElementType("g1", m1, 1.0);
    initializeGenomicElementType("g2", m2, 1.0);

    // Place elements:
    // - neutral everywhere
    // - override the single focal base with g2 so mutations there are of type m2
    initializeGenomicElement(g1, 0, L - 1);
    initializeGenomicElement(g2, FOCAL_POS, FOCAL_POS);

    // Optional: keep things simple (default infinite-sites is fine at this scale)
    // initializeMutationStackingPolicy("l"); // uncomment if you want a specific stacking policy
}


// ============================================================
// 1 early(): create population, and (once) save a restart point
// ============================================================
1 early() {
    sim.addSubpop("p1", Ne);
}

// Save a “restart point” very early so we can restart the whole simulation
// if the focal mutation is absent at the end of burn-in.
1 late() {
    // This file is used by sim.readFromPopulationFile() on failure.
    sim.outputFull(RESTART_FILE);
}


// ============================================================
// Helper: detect whether focal mutation exists anywhere in population
// ============================================================
function (logical) focalMutationPresent() {
    // Get all mutations of type m2 (focal-site type)
    muts = sim.mutationsOfType(m2);

    if (size(muts) == 0)
        return F;

    // Confirm at least one is exactly at the focal position
    return any(muts.position == FOCAL_POS);
}


// ============================================================
// End of burn-in: check presence, possibly restart, otherwise sample at t1
// ============================================================
BURNIN late() {
    // Burn-in is entirely neutral because m2 has s=0 up to this point.
    // Now we condition on the focal mutation being present as standing variation.

    if (!focalMutationPresent()) {
        catn("Focal mutation absent at end of burn-in (gen " + sim.generation + "). Restarting...");

        // Reseed to avoid repeating the same trajectory after restart
        // (SLiM provides setSeed(); rdunif() gives a new integer seed.)
        setSeed(asInteger(rdunif(1, 0, 2147483647)));

        // Restart from the saved early state
        sim.readFromPopulationFile(RESTART_FILE);

        // IMPORTANT: after readFromPopulationFile(), the simulation state is replaced.
        // Execution continues from this point in the newly loaded state.
        // We return to avoid continuing in the current (failed) state.
        return;
    }

    // ---- t1 sampling (does NOT remove individuals) ----
    t1_inds = sample(p1.individuals, SAMPLE_N);

    // Give explicit sample names for the VCF (one name per diploid individual)
    t1_names = sapply(seqLen(SAMPLE_N), "i", "t1_ind" + i);

    // Output VCF for these individuals
    // (SLiM will write diploid genotypes per individual)
    sim.outputVCF(
        t1_inds,
        filePath = VCF_T1,
        sampleNames = t1_names
    );

    catn("Wrote t1 VCF at generation " + sim.generation + " to: " + VCF_T1);
}


// ============================================================
// t1+1 early(): switch selection on for the focal mutation type
// ============================================================
(BURNIN + 1) early() {
    // Selection acts only after t1, so we switch the focal mutation type here.
    // All existing and future m2 mutations will now have fixed effect +SEL_S.
    m2.setDistribution("f", SEL_S);

    catn("Selection switched ON at generation " + sim.generation +
         " (m2 now has s=" + SEL_S + ", h=" + DOM_H + ").");
}


// ============================================================
// t2 sampling: t2 = t1 + 5 generations (t1 is at generation BURNIN)
// ============================================================
(BURNIN + T2_OFFSET) late() {
    // ---- t2 sampling ----
    t2_inds = sample(p1.individuals, SAMPLE_N);
    t2_names = sapply(seqLen(SAMPLE_N), "i", "t2_ind" + i);

    sim.outputVCF(
        t2_inds,
        filePath = VCF_T2,
        sampleNames = t2_names
    );

    catn("Wrote t2 VCF at generation " + sim.generation + " to: " + VCF_T2);
}


// ============================================================
// Finish: output tree sequence after t2 sampling
// ============================================================
(BURNIN + T2_OFFSET) late() {
    // Retain the tree sequence (for simplification/recapitation later)
    sim.treeSeqOutput(TREES_OUT);
    catn("Wrote tree sequence to: " + TREES_OUT);

    sim.simulationFinished();
}
